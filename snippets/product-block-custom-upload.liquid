{%- comment -%}
  Product Block - Custom Image Upload
  自定义图片上传区块
  
  参数:
  - block: block 对象
  - bk_stts: block settings
  - product: 产品对象
  - pr_se_id: product section id
{%- endcomment -%}

{{ 'custom-upload.css' | asset_url | stylesheet_tag }}
{%- assign upload_id = 'custom-upload-' | append: product.id | append: '-' | append: block.id -%}
{%- assign note_input_id = 'design-note-' | append: product.id | append: '-' | append: block.id -%}
{%- assign property_name = 'tm_customer_upload_image' -%}
{%- assign note_property_name = 'tm_customer_remark' -%}
{%- assign display_label = bk_stts.upload_label | default: 'Upload Your Design' -%}
{%- assign note_display_label = bk_stts.note_label | default: 'Design Note' -%}

<style>
  .t4s-custom-upload__container { width: 100%; }
  .t4s-custom-upload__button {
    width: 100% !important; display: flex; align-items: center; justify-content: center;
    gap: 8px; padding: 12px 16px; border: 1px solid; cursor: pointer; box-sizing: border-box;
  }
  .t4s-custom-upload__uploaded-display {
    display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;
    border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;
    min-height: 44px; box-sizing: border-box;
  }
  .t4s-custom-upload__uploaded-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
  .t4s-custom-upload__uploaded-thumb {
    width: auto; height: 30px; max-width: 60px; border-radius: 4px; object-fit: contain;
    flex-shrink: 0; border: 1px solid #e5e7eb;
  }
  .t4s-custom-upload__uploaded-name {
    font-size: 13px; color: #374151; overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; flex: 1; min-width: 0;
  }
  .t4s-custom-upload__uploaded-delete {
    display: flex; align-items: center; justify-content: center; width: 28px; height: 28px;
    border: none; background: transparent; cursor: pointer; color: #9ca3af;
    transition: none; flex-shrink: 0;
  }
  .t4s-custom-upload__uploaded-delete,
  .t4s-custom-upload__uploaded-delete:hover,
  .t4s-custom-upload__uploaded-delete:focus,
  .t4s-custom-upload__uploaded-delete:active {
    background: transparent !important; background-color: transparent !important;
    border-color: transparent !important; color: #9ca3af !important;
    box-shadow: none !important; outline: none !important;
  }
  .t4s-custom-upload__uploaded-delete img {
    width: 18px !important; height: 18px !important; max-width: none !important; display: block !important;
  }
</style>

<div class="t4s-custom-upload" data-custom-upload data-product-id="{{ product.id }}" data-block-id="{{ block.id }}" {{ block.shopify_attributes }}>
  <label class="t4s-custom-upload__label" for="{{ upload_id }}">
    {{ display_label }}
    {%- if bk_stts.required -%}<span style="color:#ef4444;margin-left:2px;">*</span>{%- endif -%}
  </label>
  
  <div class="t4s-custom-upload__container">
    <input type="file" id="{{ upload_id }}" class="t4s-custom-upload__input" form="product-form-{{ pr_se_id }}"
      name="properties[{{ property_name }}]" accept="image/jpeg,image/png,image/gif,image/webp"
      data-upload-input {% if bk_stts.required %}required{% endif %}>
    
    <div class="t4s-custom-upload__button" data-upload-trigger
      style="background:{{ bk_stts.btn_bg_color }};color:{{ bk_stts.btn_text_color }};border-color:{{ bk_stts.btn_border_color }};border-radius:{{ bk_stts.btn_border_radius }}px;">
      <svg class="t4s-custom-upload__icon" viewBox="0 0 24 24" width="20" height="20">
        <path fill="currentColor" d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
      </svg>
      <span class="t4s-custom-upload__text">{{ bk_stts.btn_text | default: 'Choose File' }}</span>
    </div>
    
    <div class="t4s-custom-upload__uploaded-display" data-uploaded-display style="display: none;">
      <div class="t4s-custom-upload__uploaded-left">
        <img src="" alt="Uploaded" class="t4s-custom-upload__uploaded-thumb" data-uploaded-thumb height="30">
        <span class="t4s-custom-upload__uploaded-name" data-uploaded-name></span>
      </div>
      <button type="button" class="t4s-custom-upload__uploaded-delete" data-uploaded-delete aria-label="Remove uploaded file">
        <img src="{{ 'icon_trash.png' | asset_url }}" alt="Delete" width="18" height="18" style="display:block;">
      </button>
    </div>
  </div>
  
  <div class="t4s-custom-upload__filename" data-filename style="display: none;">
    {{ bk_stts.no_file_text | default: 'No file chosen' }}
  </div>
  
  {%- if bk_stts.show_note_input -%}
  <div class="t4s-custom-upload__note-section" style="margin-top: 16px;">
    <label class="t4s-custom-upload__label" for="{{ note_input_id }}">
      {{ note_display_label }}
      {%- if bk_stts.note_required -%}<span style="color:#ef4444;margin-left:2px;">*</span>{%- endif -%}
    </label>
    <input type="text" id="{{ note_input_id }}" class="t4s-custom-upload__note-input"
      form="product-form-{{ pr_se_id }}" name="properties[{{ note_property_name }}]"
      placeholder="{{ bk_stts.note_placeholder | default: 'Enter your personalization text...' }}"
      data-design-note-input maxlength="{{ bk_stts.note_max_length | default: 100 }}"
      {% if bk_stts.note_required %}required{% endif %}>
    {%- if bk_stts.note_description != blank -%}
      <p class="t4s-custom-upload__note-description">{{ bk_stts.note_description }}</p>
    {%- endif -%}
  </div>
  {%- endif -%}
  
  <div class="t4s-custom-upload__preview-wrapper" data-preview-wrapper style="display: none !important;">
    <div class="t4s-custom-upload__preview">
      <img src="" alt="Preview" data-preview-image class="t4s-custom-upload__preview-img" width="150" height="150">
      <button type="button" class="t4s-custom-upload__remove" data-remove-upload aria-label="Remove image">
        <svg viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
  </div>

  {%- if bk_stts.show_description and bk_stts.description != blank -%}
    <p class="t4s-custom-upload__description" style="display: none;">{{ bk_stts.description }}</p>
  {%- endif -%}
  
  <input type="hidden" form="product-form-{{ pr_se_id }}" data-image-data value="">
  <input type="hidden" form="product-form-{{ pr_se_id }}" name="properties[_tm_customer_upload_filename]" data-upload-filename value="">
</div>

<script>
(function() {
  var blockId = '{{ block.id }}', productId = '{{ product.id }}';
  var noFileText = {{ bk_stts.no_file_text | default: 'No file chosen' | json }};
  
  function initUpload() {
    var container = document.querySelector('[data-custom-upload][data-block-id="' + blockId + '"]');
    if (!container) return;
    
    var input = container.querySelector('[data-upload-input]');
    var trigger = container.querySelector('[data-upload-trigger]');
    var filename = container.querySelector('[data-filename]');
    var previewWrapper = container.querySelector('[data-preview-wrapper]');
    var previewImage = container.querySelector('[data-preview-image]');
    var removeBtn = container.querySelector('[data-remove-upload]');
    var imageDataInput = container.querySelector('[data-image-data]');
    var designNoteInput = container.querySelector('[data-design-note-input]');
    var filenameInput = container.querySelector('[data-upload-filename]');
    var uploadedDisplay = container.querySelector('[data-uploaded-display]');
    var uploadedThumb = container.querySelector('[data-uploaded-thumb]');
    var uploadedName = container.querySelector('[data-uploaded-name]');
    var uploadedDelete = container.querySelector('[data-uploaded-delete]');
    
    function showUploadedState(imgSrc, fileName) {
      trigger.style.display = 'none';
      uploadedThumb.src = imgSrc;
      uploadedName.textContent = fileName;
      uploadedDisplay.style.display = 'flex';
    }
    
    function showInitialState() {
      uploadedDisplay.style.display = 'none';
      uploadedThumb.src = '';
      uploadedName.textContent = '';
      trigger.style.display = 'flex';
    }
    
    var saved = localStorage.getItem('custom_upload_' + productId);
    if (saved) {
      try {
        var data = JSON.parse(saved);
        if (data.imageData && data.filename) {
          previewImage.src = data.imageData;
          filename.textContent = data.filename;
          imageDataInput.value = data.imageData;
          showUploadedState(data.imageData, data.filename);
        }
        if (data.designNote && designNoteInput) designNoteInput.value = data.designNote;
      } catch (e) {}
    }
    
    trigger.addEventListener('click', function() { input.click(); });
    
    var pplrInput = null, isSyncing = false;
    
    function findPplrInput() {
      var pplrWrapper = document.querySelector('.pplr-wrapper.pplr-single-line-text, .pplr-wrapper.pplr-text');
      return pplrWrapper ? pplrWrapper.querySelector('input[type="text"], textarea') : null;
    }
    
    function syncFromPplr() {
      if (isSyncing || !pplrInput || !designNoteInput) return;
      isSyncing = true;
      designNoteInput.value = pplrInput.value;
      saveUploadData();
      isSyncing = false;
    }
    
    function syncToPplr() {
      if (isSyncing || !pplrInput || !designNoteInput) return;
      isSyncing = true;
      pplrInput.value = designNoteInput.value;
      pplrInput.dispatchEvent(new Event('input', { bubbles: true }));
      pplrInput.dispatchEvent(new Event('change', { bubbles: true }));
      isSyncing = false;
    }
    
    function bindPplrInput() {
      pplrInput = findPplrInput();
      if (pplrInput && designNoteInput) {
        if (pplrInput.value && !designNoteInput.value) syncFromPplr();
        else if (designNoteInput.value && !pplrInput.value) syncToPplr();
        pplrInput.addEventListener('input', syncFromPplr);
        pplrInput.addEventListener('change', syncFromPplr);
      }
    }
    
    setTimeout(bindPplrInput, 500);
    setTimeout(bindPplrInput, 1500);
    setTimeout(bindPplrInput, 3000);
    
    var pplrObserver = new MutationObserver(function() { if (!pplrInput) bindPplrInput(); });
    pplrObserver.observe(document.body, { childList: true, subtree: true });
    
    if (designNoteInput) {
      designNoteInput.addEventListener('input', function() {
        saveUploadData();
        syncToPplr();
      });
    }
    
    function saveUploadData() {
      var saveData = {
        imageData: imageDataInput.value || '',
        filename: filename.textContent !== noFileText ? filename.textContent : '',
        designNote: designNoteInput ? designNoteInput.value : '',
        timestamp: Date.now()
      };
      localStorage.setItem('custom_upload_' + productId, JSON.stringify(saveData));
      var cartImages = {};
      try { var s = localStorage.getItem('cart_uploaded_images'); if(s) cartImages = JSON.parse(s); } catch(e){}
      cartImages[productId] = saveData;
      localStorage.setItem('cart_uploaded_images', JSON.stringify(cartImages));
    }
    
    input.addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/png','image/gif','image/webp'].includes(file.type)) {
        alert('Please select a valid image file'); return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB'); return;
      }
      filename.textContent = file.name;
      if (filenameInput) filenameInput.value = file.name;
      var reader = new FileReader();
      reader.onload = function(re) {
        var imgData = re.target.result;
        previewImage.src = imgData;
        imageDataInput.value = imgData;
        showUploadedState(imgData, file.name);
        saveUploadData();
        window.dispatchEvent(new CustomEvent('customImageUploaded', { detail: { productId: productId } }));
      };
      reader.readAsDataURL(file);
    });
    
    removeBtn.addEventListener('click', function(e) {
      e.preventDefault(); e.stopPropagation();
      input.value = ''; filename.textContent = noFileText;
      previewImage.src = ''; imageDataInput.value = '';
      if (filenameInput) filenameInput.value = '';
      showInitialState(); saveUploadData();
      window.dispatchEvent(new CustomEvent('customImageRemoved', { detail: { productId: productId } }));
    });
    
    uploadedDelete.addEventListener('click', function(e) {
      e.preventDefault(); e.stopPropagation();
      input.value = ''; filename.textContent = noFileText;
      previewImage.src = ''; imageDataInput.value = '';
      if (filenameInput) filenameInput.value = '';
      showInitialState(); saveUploadData();
      window.dispatchEvent(new CustomEvent('customImageRemoved', { detail: { productId: productId } }));
    });
    
    function clearUploadData() {
      input.value = ''; filename.textContent = noFileText;
      previewImage.src = ''; imageDataInput.value = '';
      if (filenameInput) filenameInput.value = '';
      if (designNoteInput) designNoteInput.value = '';
      showInitialState();
      if (pplrInput) {
        pplrInput.value = '';
        pplrInput.dispatchEvent(new Event('input', { bubbles: true }));
        pplrInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
      localStorage.removeItem('custom_upload_' + productId);
      try {
        var cartImages = JSON.parse(localStorage.getItem('cart_uploaded_images') || '{}');
        delete cartImages[productId];
        localStorage.setItem('cart_uploaded_images', JSON.stringify(cartImages));
      } catch(e) {}
    }
    
    var productForm = document.querySelector('form[action*="/cart/add"]');
    if (productForm) {
      productForm.addEventListener('submit', function() { setTimeout(clearUploadData, 500); });
    }
    document.addEventListener('t4s:cart:added', clearUploadData);
    window.addEventListener('cart:refresh', clearUploadData);
    var atcButtons = document.querySelectorAll('[data-action-atc], [name="add"], .t4s-btn__atc, .product-form__submit');
    atcButtons.forEach(function(btn) {
      btn.addEventListener('click', function() { setTimeout(clearUploadData, 1000); });
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUpload);
  } else {
    initUpload();
  }
})();
</script>
