{%- comment -%}
  Product Color Selector Snippet - ç‹¬ç«‹çš„ Color Selector Block
  
  è¿™ä¸ª snippet åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ color selectorï¼Œå®ƒä¼šï¼š
  1. æ¸²æŸ“ä¸€ä¸ªéšè—çš„ product formï¼ˆåŒ…å«å®Œæ•´çš„ variant é€»è¾‘ï¼‰
  2. åªæ˜¾ç¤º color é€‰é¡¹
  3. ä½¿ç”¨ä¸»é¢˜è‡ªå¸¦çš„ JavaScript æ¥å¤„ç† variant åˆ‡æ¢
  
  Parameters:
  - product: Product object
  - current_variant: Current variant object
  - pr_se_id: Product section ID
  - bk_stts: Block settings
  - isProductDefault: Boolean
  - get_color: Array of color keywords
  - choose_an_option: Translation string
  - name_sizeg: Size guide name
  - html_sizeg: Size guide HTML
  - show_tooltip: Tooltip setting
{%- endcomment -%}

{%- liquid
  assign color_mode = bk_stts.color_mode | default: 'color'
  assign selector_mode = bk_stts.selector_mode | default: 'default'
  assign color_size = bk_stts.color_size | default: 'medium'
  
  assign color_swatch = 'disabled-'
  assign color_mode_list = 'color, color is-sw-cl__round, variant_image, variant_image is-sw-cl__round' | split: ', '
  if color_mode_list contains color_mode
    assign color_swatch = 'is-sw__color '
  endif
  
  if color_mode contains 'color' or color_mode contains 'variant'
    assign show_tooltip = ''
  else
    assign show_tooltip = '-off'
  endif
-%}

{%- if isProductDefault == false -%}
  {{ 'swatch.css' | asset_url | append: '?v=20251201-v3' | stylesheet_tag }}
  
  {%- comment -%} åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ form ID {%- endcomment -%}
  {%- assign independent_form_id = 'product-form-independent-' | append: pr_se_id -%}
  
  {%- comment -%} æ¸²æŸ“ä¸€ä¸ªç‹¬ç«‹çš„ product formï¼ŒåŒ…å«å¿…è¦çš„åŒ…è£…å™¨ {%- endcomment -%}
  <div class="t4s-independent-color-selector-wrapper">
    <div data-callBackVariant id="t4s-callBackVariant{{ independent_form_id }}">
      {%- comment -%} éšè—çš„ JSON æ•°æ®ï¼ˆä¸»é¢˜ JS éœ€è¦ï¼‰{%- endcomment -%}
      <script class="pr_variants_json" type="application/json">
        {{ product.variants | json }}
      </script>
      <script class="pr_options_json" type="application/json">
        {{ product.options_with_values | json }}
      </script>
      
      <form 
        id="{{ independent_form_id }}"
        class="t4s-product-form"
        data-productid="{{ product.id }}"
        data-type="add-to-cart-form"
        style="display: contents;"
      >
      {%- comment -%} éšè—çš„ variant selectï¼ˆä¸»é¢˜ JS éœ€è¦å®ƒæ¥å·¥ä½œï¼‰{%- endcomment -%}
      <select name="id" style="display: none;">
        {%- for variant in product.variants -%}
          <option 
            value="{{ variant.id }}"
            {% if variant == current_variant %}selected="selected"{% endif %}
          >
            {{ variant.title }}
          </option>
        {%- endfor -%}
      </select>
      
      {%- comment -%} åªæ¸²æŸ“ color selector {%- endcomment -%}
      <div 
        class="t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ color_size }} t4s-selector-mode__{{ selector_mode }}"
        data-independent-color-selector
      >
    {%- for option in product.options_with_values -%}
      {%- liquid
        if option.values.size == 1
          assign selected_value = option.values.first
        else
          assign option_index = 'option' | append: forloop.index
          assign selected_value = current_variant[option_index]
        endif
        assign option_name = option.name
        assign name_downcase = option_name | downcase
      -%}

      {%- if get_color contains name_downcase -%}
        <div
          data-swatch-option
          data-id="{{ forloop.index0 }}"
          class="t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }}"
        >
          <h4 class="t4s-swatch__title">
            <span>
              {{- option_name }}:
              <span data-current-value class="t4s-dib t4s-swatch__current">
                {{- selected_value | default: choose_an_option -}}
              </span>
            </span>
            {%- if name_sizeg == name_downcase %}{{ html_sizeg }}{% endif %}
          </h4>
          <div data-swatch-list class="t4s-swatch__list">
            {%- if color_mode != 'dropdown' -%}
              {%- for value in option.values -%}
                {%- liquid
                  assign swatch_focal_point = null
                  if value.swatch.image
                    assign image_url = value.swatch.image | image_url: width: 100, height: 100
                    assign swatch_value = 'url(' | append: image_url | append: ')'
                    assign swatch_focal_point = value.swatch.image.presentation.focal_point
                  elsif value.swatch.color
                    assign swatch_value = value.swatch.color
                  else
                    assign swatch_value = null
                  endif
                -%}
                <div
                  data-swatch-item
                  data-tooltip{{ show_tooltip }}="top"
                  title="{{ value | escape }}"
                  class="t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                  data-value="{{ value | escape }}"
                  {% if swatch_value %}
                    style="--swatch--background: {{ swatch_value }};{% if swatch_focal_point %} --swatch-focal-point: {{ swatch_focal_point }};{% endif %}"
                  {% endif %}
                >
                  {{ value }}
                </div>
              {%- endfor -%}

            {%- else -%}
              <button
                type="button"
                data-dropdown-open
                data-position="bottom-end"
                data-id="t4s_nt_{{ pr_se_id }}{{ forloop.index }}"
              >
                <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                <svg class="t4s-icon-select-arrow" role="presentation" viewBox="0 0 19 12">
                  <use xlink:href="#t4s-select-arrow"></use>
                </svg>
              </button>
              <div
                data-dropdown-wrapper
                class="t4s-dropdown__wrapper t4s-current-scrollbar"
                id="t4s_nt_{{ pr_se_id }}{{ forloop.index }}"
              >
                <div class="t4s-drop-arrow"></div>
                <div class="t4s-dropdown__header">
                  <span class="t4s-dropdown__title">
                    {{- option_name }}:
                    <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                  </span>
                  <button type="button" data-dropdown-close aria-label="{{ 'general.aria.close' | t }}">
                    <svg role="presentation" class="t4s-iconsvg-close" viewBox="0 0 16 14">
                      <path d="M15 0L1 14m14 0L1 0" stroke="currentColor" fill="none" fill-rule="evenodd"></path>
                    </svg>
                  </button>
                </div>
                <div class="t4s-dropdown__content">
                  {%- for value in option.values -%}
                    {%- liquid
                      assign swatch_focal_point = null
                      if value.swatch.image
                        assign image_url = value.swatch.image | image_url: width: 100, height: 100
                        assign swatch_value = 'url(' | append: image_url | append: ')'
                        assign swatch_focal_point = value.swatch.image.presentation.focal_point
                      elsif value.swatch.color
                        assign swatch_value = value.swatch.color
                      else
                        assign swatch_value = null
                      endif
                    -%}
                    <div
                      data-swatch-item
                      data-dropdown-off
                      class="t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                      data-value="{{ value | escape }}"
                      {% if swatch_value %}
                        style="--swatch--background: {{ swatch_value }};{% if swatch_focal_point %} --swatch-focal-point: {{ swatch_focal_point }};{% endif %}"
                      {% endif %}
                    >
                      {{ value }}
                    </div>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}
    {%- endfor -%}
      </div>
      </form>
    </div>
  </div>
  
  {%- comment -%} JavaScript: ç›´æ¥ç›‘å¬ swatch ç‚¹å‡»ï¼Œè§¦å‘ä¸» form çš„å¯¹åº” swatchï¼Œå¹¶å®ç°å¤šé€‰é¡¹è”åŠ¨ç­›é€‰ {%- endcomment -%}
  <script>
    (function() {
      function initIndependentColorSelector() {
        var independentWrapper = document.querySelector('[data-callBackVariant][id="t4s-callBackVariant{{ independent_form_id }}"]');
        var mainWrapper = document.querySelector('[data-callBackVariant][id="t4s-callBackVariant{{ 'product-form-' | append: pr_se_id }}"]');
        
        if (!independentWrapper || !mainWrapper) {
          console.log('Wrappers not found, retrying...');
          setTimeout(initIndependentColorSelector, 100);
          return;
        }
        
        var independentSwatch = independentWrapper.querySelector('.t4s-swatch');
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šæŸ¥æ‰¾ä¸» form ä¸­æ‰€æœ‰çš„ swatch å®¹å™¨
        var mainSwatches = mainWrapper.querySelectorAll('.t4s-swatch');
        var mainSwatch = null;
        
        // å¦‚æœæœ‰å¤šä¸ª swatchï¼Œæ‰¾åˆ°åŒ…å«é€‰é¡¹çš„é‚£ä¸ª
        if (mainSwatches.length > 0) {
          console.log('Found', mainSwatches.length, 'swatch containers in main form');
          
          // ä¼˜å…ˆæŸ¥æ‰¾åŒ…å« data-swatch-option çš„ swatch
          for (var i = 0; i < mainSwatches.length; i++) {
            var swatchOptions = mainSwatches[i].querySelectorAll('[data-swatch-option]');
            if (swatchOptions.length > 0) {
              mainSwatch = mainSwatches[i];
              console.log('âœ… Using swatch container', i, 'with', swatchOptions.length, 'options');
              break;
            }
          }
          
          // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
          if (!mainSwatch) {
            mainSwatch = mainSwatches[0];
            console.log('âš ï¸ Using first swatch container as fallback');
          }
        }
        
        if (!independentSwatch) {
          console.log('Independent swatch not found, retrying...');
          setTimeout(initIndependentColorSelector, 100);
          return;
        }
        
        console.log('âœ… Independent color selector initialized');
        console.log('Independent swatch:', independentSwatch);
        console.log('Main swatch:', mainSwatch);
        
        if (mainSwatch) {
          var mainOptions = mainSwatch.querySelectorAll('[data-swatch-option]');
          console.log('Main swatch has', mainOptions.length, 'options');
          mainOptions.forEach(function(opt, idx) {
            console.log('  Option', idx, '- data-id:', opt.getAttribute('data-id'), 'class:', opt.className);
          });
        }
        
        // è·å– variants å’Œ options æ•°æ®
        var variantsJson = independentWrapper.querySelector('.pr_variants_json');
        var optionsJson = independentWrapper.querySelector('.pr_options_json');
        
        if (!variantsJson || !optionsJson) {
          console.log('âŒ Variants or options JSON not found');
          return;
        }
        
        var variants = JSON.parse(variantsJson.textContent);
        var options = JSON.parse(optionsJson.textContent);
        
        console.log('Variants:', variants);
        console.log('Options:', options);
        
        // è·å–å½“å‰é€‰ä¸­çš„å€¼ï¼ˆåŒ…æ‹¬ä¸» form ä¸­çš„å…¶ä»–é€‰é¡¹ï¼‰
        function getCurrentSelectedValues() {
          var selectedValues = {};
          
          // é¦–å…ˆä»ç‹¬ç«‹é€‰æ‹©å™¨è·å–å€¼
          independentSwatch.querySelectorAll('[data-swatch-option]').forEach(function(option) {
            var optionIndex = option.getAttribute('data-id');
            var selectedItem = option.querySelector('[data-swatch-item].is--selected');
            if (selectedItem) {
              selectedValues[optionIndex] = selectedItem.getAttribute('data-value');
            }
          });
          
          // ğŸ”§ å…³é”®ä¿®å¤ï¼šä»ä¸» form è·å–å…¶ä»–é€‰é¡¹çš„å€¼
          if (mainSwatch) {
            mainSwatch.querySelectorAll('[data-swatch-option]').forEach(function(mainOption) {
              var mainOptionIndex = mainOption.getAttribute('data-id');
              
              // å¦‚æœç‹¬ç«‹é€‰æ‹©å™¨ä¸­æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œä»ä¸» form è·å–
              if (!selectedValues.hasOwnProperty(mainOptionIndex)) {
                var mainSelectedItem = mainOption.querySelector('[data-swatch-item].is--selected');
                if (mainSelectedItem) {
                  selectedValues[mainOptionIndex] = mainSelectedItem.getAttribute('data-value');
                }
              }
            });
          }
          
          return selectedValues;
        }
        
        // ğŸ”§ æ”¹è¿›ï¼šé€šè¿‡é€‰é¡¹åç§°åŒ¹é…ï¼Œè€Œä¸æ˜¯ç´¢å¼•
        function findMainOption(independentOption) {
          var optionIndex = independentOption.getAttribute('data-id');
          var optionName = independentOption.className.match(/is-t4s-name__([^\s]+)/);
          var optionNameValue = optionName ? optionName[1] : null;
          
          console.log('ğŸ” Looking for main option - index:', optionIndex, 'name:', optionNameValue);
          
          // é¦–å…ˆå°è¯•é€šè¿‡ data-id åŒ¹é…
          var mainOption = mainWrapper.querySelector('[data-swatch-option][data-id="' + optionIndex + '"]');
          
          if (mainOption) {
            console.log('  âœ… Found by data-id');
            return mainOption;
          }
          
          // å¦‚æœé€šè¿‡ data-id æ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡ class åç§°åŒ¹é…
          if (optionNameValue) {
            mainOption = mainWrapper.querySelector('[data-swatch-option].is-t4s-name__' + optionNameValue);
            if (mainOption) {
              console.log('  âœ… Found by class name:', optionNameValue);
              return mainOption;
            }
            
            // ğŸ”§ é¢å¤–å°è¯•ï¼šæŸ¥æ‰¾åŒ…å«é¢œè‰²ç›¸å…³ class çš„é€‰é¡¹
            if (optionNameValue === 'color' || optionNameValue === 'colour') {
              mainOption = mainWrapper.querySelector('[data-swatch-option].is-t4s-style__color');
              if (mainOption) {
                console.log('  âœ… Found by color style class');
                return mainOption;
              }
            }
          }
          
          // ğŸ”§ æ”¹è¿›ï¼šå¦‚æœç‹¬ç«‹é€‰æ‹©å™¨åªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œå°è¯•æ‰¾ä¸» form ä¸­å”¯ä¸€çš„é¢œè‰²é€‰é¡¹
          var independentOptions = independentSwatch.querySelectorAll('[data-swatch-option]');
          
          if (independentOptions.length === 1) {
            console.log('  â†’ Independent has only 1 option, looking for single color option in main');
            
            // æŸ¥æ‰¾ä¸» form ä¸­æ‰€æœ‰é¢œè‰²é€‰é¡¹
            var mainColorOptions = mainWrapper.querySelectorAll('[data-swatch-option].is-t4s-style__color');
            
            if (mainColorOptions.length === 1) {
              console.log('  âœ… Found by single color option fallback');
              return mainColorOptions[0];
            } else if (mainColorOptions.length > 1) {
              console.log('  âš ï¸ Multiple color options found:', mainColorOptions.length);
            }
            
            // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•æ‰¾ä¸» form ä¸­å”¯ä¸€çš„é€‰é¡¹
            var mainOptions = mainWrapper.querySelectorAll('[data-swatch-option]');
            if (mainOptions.length === 1) {
              console.log('  âœ… Found by single option fallback');
              return mainOptions[0];
            }
          }
          
          console.log('  âŒ Not found');
          console.log('  â†’ Available main options:');
          var allMainOptions = mainWrapper.querySelectorAll('[data-swatch-option]');
          allMainOptions.forEach(function(opt, idx) {
            console.log('    ', idx, '- data-id:', opt.getAttribute('data-id'), 'classes:', opt.className);
          });
          
          return null;
        }
        
        // æ›´æ–°å¯ç”¨é€‰é¡¹ï¼ˆç¦ç”¨/å¯ç”¨ swatch itemsï¼‰
        function updateAvailableOptions() {
          console.log('ğŸ”„ Updating available options by syncing from main form');
          
          // ğŸ”§ å…³é”®ä¿®å¤ï¼šç›´æ¥ä»ä¸» form åŒæ­¥çŠ¶æ€ï¼Œä¸è¦è‡ªå·±è®¡ç®—
          if (mainSwatch) {
            independentSwatch.querySelectorAll('[data-swatch-option]').forEach(function(independentOption) {
              // ğŸ”§ ä½¿ç”¨æ”¹è¿›çš„æŸ¥æ‰¾å‡½æ•°
              var mainOption = findMainOption(independentOption);
              
              if (!mainOption) {
                console.log('âš ï¸ Main option not found, skipping');
                return;
              }
              
              var optionIndex = independentOption.getAttribute('data-id');
              console.log('âœ… Syncing option', optionIndex, 'from main form');
              
              // éå†ç‹¬ç«‹é€‰æ‹©å™¨ä¸­çš„æ¯ä¸ª item
              independentOption.querySelectorAll('[data-swatch-item]').forEach(function(independentItem) {
                var itemValue = independentItem.getAttribute('data-value');
                
                // æŸ¥æ‰¾ä¸» form ä¸­å¯¹åº”çš„ item
                var mainItem = mainOption.querySelector('[data-swatch-item][data-value="' + itemValue + '"]');
                
                if (!mainItem) {
                  // ä¸» form ä¸­æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œéšè—å®ƒ
                  independentItem.classList.add('is--soldout', 'is--unavailable', 'is--hidden');
                  independentItem.setAttribute('disabled', 'disabled');
                  independentItem.style.display = 'none';
                } else {
                  // ç›´æ¥å¤åˆ¶ä¸» form çš„çŠ¶æ€
                  if (mainItem.classList.contains('is--soldout') || 
                      mainItem.style.display === 'none' ||
                      mainItem.classList.contains('is--hidden')) {
                    independentItem.classList.add('is--soldout', 'is--unavailable', 'is--hidden');
                    independentItem.setAttribute('disabled', 'disabled');
                    independentItem.style.display = 'none';
                  } else {
                    independentItem.classList.remove('is--soldout', 'is--unavailable', 'is--hidden');
                    independentItem.removeAttribute('disabled');
                    independentItem.style.display = '';
                  }
                }
              });
            });
          } else {
            // å¦‚æœæ²¡æœ‰ä¸» swatchï¼Œä½¿ç”¨ variant è®¡ç®—é€»è¾‘
            var selectedValues = getCurrentSelectedValues();
            
            console.log('ğŸ”„ No main swatch, calculating from variants. Current selection:', selectedValues);
            
            independentSwatch.querySelectorAll('[data-swatch-option]').forEach(function(option) {
              var optionIndex = option.getAttribute('data-id');
              
              option.querySelectorAll('[data-swatch-item]').forEach(function(item) {
                var itemValue = item.getAttribute('data-value');
                
                // æ„å»ºæµ‹è¯•é€‰é¡¹ç»„åˆ
                var testValues = Object.assign({}, selectedValues);
                testValues[optionIndex] = itemValue;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„ variant
                var hasMatchingVariant = variants.some(function(variant) {
                  var matches = true;
                  for (var idx in testValues) {
                    var optionKey = 'option' + (parseInt(idx) + 1);
                    if (variant[optionKey] !== testValues[idx]) {
                      matches = false;
                      break;
                    }
                  }
                  return matches;
                });
                
                // æ›´æ–° item çŠ¶æ€
                if (hasMatchingVariant) {
                  item.classList.remove('is--soldout', 'is--unavailable', 'is--hidden');
                  item.removeAttribute('disabled');
                  item.style.display = '';
                } else {
                  item.classList.add('is--soldout', 'is--unavailable', 'is--hidden');
                  item.setAttribute('disabled', 'disabled');
                  item.style.display = 'none';
                }
              });
            });
          }
          
          console.log('âœ… Available options updated');
        }
        
        // ç›‘å¬ç‹¬ç«‹ swatch çš„ç‚¹å‡»äº‹ä»¶
        independentSwatch.addEventListener('click', function(e) {
          var clickedItem = e.target.closest('[data-swatch-item]');
          if (!clickedItem) return;
          
          // å¦‚æœç‚¹å‡»çš„æ˜¯ç¦ç”¨çš„é€‰é¡¹ï¼Œé˜»æ­¢æ“ä½œ
          if (clickedItem.classList.contains('is--soldout') || clickedItem.classList.contains('is--unavailable')) {
            console.log('ğŸš« Clicked item is unavailable');
            e.preventDefault();
            e.stopPropagation();
            return;
          }
          
          console.log('ğŸ¨ Independent swatch clicked');
          
          // é˜»æ­¢é»˜è®¤è¡Œä¸º
          e.preventDefault();
          e.stopPropagation();
          
          var swatchOption = clickedItem.closest('[data-swatch-option]');
          if (!swatchOption) return;
          
          var optionIndex = swatchOption.getAttribute('data-id');
          var selectedValue = clickedItem.getAttribute('data-value');
          
          console.log('Option index:', optionIndex, 'Value:', selectedValue);
          
          // æ›´æ–°ç‹¬ç«‹ selector çš„é€‰ä¸­çŠ¶æ€
          swatchOption.querySelectorAll('[data-swatch-item]').forEach(function(item) {
            item.classList.remove('is--selected');
          });
          clickedItem.classList.add('is--selected');
          
          // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
          var currentValueEl = swatchOption.querySelector('[data-current-value]');
          if (currentValueEl) {
            currentValueEl.textContent = selectedValue;
          }
          
          // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆ¤æ–­æ˜¯å•å±‚è¿˜æ˜¯å¤šå±‚é€»è¾‘
          var independentOptions = independentSwatch.querySelectorAll('[data-swatch-option]');
          var isSingleLayer = independentOptions.length === 1;
          
          console.log('ğŸ“Š Detection: ' + (isSingleLayer ? 'Single-layer' : 'Multi-layer') + ' color selection');
          
          // ğŸ”§ å°è¯•æŸ¥æ‰¾ä¸» form çš„ swatch
          var mainSwatchOption = findMainOption(swatchOption);
          
          // ğŸ”§ å†³ç­–é€»è¾‘ï¼š
          // 1. å¦‚æœæ‰¾åˆ°ä¸» swatch ä¸”æœ‰å¯¹åº”çš„ item â†’ ä½¿ç”¨å¤šå±‚é€»è¾‘ï¼ˆè§¦å‘ä¸» swatchï¼‰
          // 2. å¦‚æœæ‰¾ä¸åˆ°ä¸» swatch æˆ–æ‰¾ä¸åˆ°å¯¹åº” item â†’ ä½¿ç”¨å•å±‚é€»è¾‘ï¼ˆç›´æ¥æ›´æ–° variantï¼‰
          
          var useMultiLayerLogic = false;
          var mainSwatchItem = null;
          
          if (mainSwatchOption) {
            mainSwatchItem = mainSwatchOption.querySelector('[data-swatch-item][data-value="' + selectedValue + '"]');
            if (mainSwatchItem) {
              useMultiLayerLogic = true;
            }
          }
          
          if (useMultiLayerLogic) {
            // ========== å¤šå±‚é€»è¾‘ï¼šè§¦å‘ä¸» form çš„ swatch ==========
            console.log('âœ… Using MULTI-LAYER logic: Triggering main swatch click');
            
            // è§¦å‘ä¸» swatch çš„ç‚¹å‡»äº‹ä»¶
            mainSwatchItem.click();
            
            // ç­‰å¾…ä¸»é¢˜ JS å¤„ç†å®Œæˆåï¼ŒåŒæ­¥çŠ¶æ€
            setTimeout(function() {
              console.log('â±ï¸ Delayed sync after main swatch click');
              updateAvailableOptions();
            }, 100);
            
            // å†ç­‰å¾…ä¸€æ¬¡ï¼Œç¡®ä¿æ‰€æœ‰å¼‚æ­¥æ›´æ–°å®Œæˆ
            setTimeout(function() {
              console.log('â±ï¸ Final sync after main swatch click');
              updateAvailableOptions();
            }, 300);
            
          } else {
            // ========== å•å±‚é€»è¾‘ï¼šç›´æ¥æ›´æ–° variant ==========
            console.log('âœ… Using SINGLE-LAYER logic: Direct variant update');
            
            // æŸ¥æ‰¾åŒ¹é…çš„ variant
            var selectedValues = getCurrentSelectedValues();
            
            // ğŸ”§ ä»ä¸» form è·å–å…¶ä»–é€‰é¡¹çš„å€¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (mainSwatch) {
              mainSwatch.querySelectorAll('[data-swatch-option]').forEach(function(mainOption) {
                var mainOptionIndex = mainOption.getAttribute('data-id');
                
                // å¦‚æœç‹¬ç«‹é€‰æ‹©å™¨ä¸­æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œä»ä¸» form è·å–
                if (!selectedValues.hasOwnProperty(mainOptionIndex)) {
                  var mainSelectedItem = mainOption.querySelector('[data-swatch-item].is--selected');
                  if (mainSelectedItem) {
                    selectedValues[mainOptionIndex] = mainSelectedItem.getAttribute('data-value');
                    console.log('ğŸ“¥ Got value from main form - option', mainOptionIndex, ':', selectedValues[mainOptionIndex]);
                  }
                }
              });
            }
            
            console.log('ğŸ” Looking for variant with values:', selectedValues);
            
            var matchedVariant = variants.find(function(variant) {
              var matches = true;
              for (var idx in selectedValues) {
                var optionKey = 'option' + (parseInt(idx) + 1);
                if (variant[optionKey] !== selectedValues[idx]) {
                  matches = false;
                  break;
                }
              }
              return matches;
            });
            
            if (matchedVariant) {
              console.log('âœ… Found matching variant:', matchedVariant);
              
              // æ›´æ–°ä¸» form çš„ select
              var mainForm = mainWrapper.querySelector('form');
              if (mainForm) {
                var mainSelect = mainForm.querySelector('select[name="id"]');
                if (mainSelect) {
                  mainSelect.value = matchedVariant.id;
                  
                  // è§¦å‘ change äº‹ä»¶
                  var changeEvent = new Event('change', { bubbles: true });
                  mainSelect.dispatchEvent(changeEvent);
                  
                  console.log('âœ… Main select updated to variant:', matchedVariant.id);
                  
                  // ğŸ”§ å•å±‚é€»è¾‘ä¹Ÿéœ€è¦åŒæ­¥ä¸» form çš„é€‰ä¸­çŠ¶æ€
                  if (mainSwatch) {
                    setTimeout(function() {
                      console.log('â±ï¸ Syncing main form selection state');
                      
                      // æ›´æ–°ä¸» form ä¸­å¯¹åº”é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                      mainSwatch.querySelectorAll('[data-swatch-option]').forEach(function(mainOption) {
                        var mainOptionIndex = mainOption.getAttribute('data-id');
                        
                        if (selectedValues.hasOwnProperty(mainOptionIndex)) {
                          var valueToSelect = selectedValues[mainOptionIndex];
                          
                          // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                          mainOption.querySelectorAll('[data-swatch-item]').forEach(function(item) {
                            item.classList.remove('is--selected');
                          });
                          
                          // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å¯¹åº”çš„ item
                          var itemToSelect = mainOption.querySelector('[data-swatch-item][data-value="' + valueToSelect + '"]');
                          if (itemToSelect) {
                            itemToSelect.classList.add('is--selected');
                            
                            // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                            var mainCurrentValueEl = mainOption.querySelector('[data-current-value]');
                            if (mainCurrentValueEl) {
                              mainCurrentValueEl.textContent = valueToSelect;
                            }
                          }
                        }
                      });
                    }, 50);
                  }
                }
              }
            } else {
              console.log('âŒ No matching variant found for values:', selectedValues);
            }
          }
        });
        
        // ç›‘å¬ä¸» swatch çš„å˜åŒ–ï¼ŒåŒæ­¥åˆ°ç‹¬ç«‹ swatch
        if (mainSwatch) {
          var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                var target = mutation.target;
                if (target.hasAttribute('data-swatch-item') && target.classList.contains('is--selected')) {
                  var swatchOption = target.closest('[data-swatch-option]');
                  if (!swatchOption) return;
                  
                  var optionIndex = swatchOption.getAttribute('data-id');
                  var selectedValue = target.getAttribute('data-value');
                  
                  console.log('ğŸ”„ Main swatch changed - Option:', optionIndex, 'Value:', selectedValue);
                  
                  // åŒæ­¥åˆ°ç‹¬ç«‹ swatchï¼ˆå¦‚æœç‹¬ç«‹é€‰æ‹©å™¨ä¸­æœ‰è¿™ä¸ªé€‰é¡¹ï¼‰
                  var independentOption = independentSwatch.querySelector('[data-swatch-option][data-id="' + optionIndex + '"]');
                  if (independentOption) {
                    console.log('  â†’ Syncing selection to independent swatch');
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    independentOption.querySelectorAll('[data-swatch-item]').forEach(function(item) {
                      item.classList.remove('is--selected');
                    });
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å¯¹åº”çš„ item
                    var independentItem = independentOption.querySelector('[data-swatch-item][data-value="' + selectedValue + '"]');
                    if (independentItem) {
                      independentItem.classList.add('is--selected');
                      
                      // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                      var currentValueEl = independentOption.querySelector('[data-current-value]');
                      if (currentValueEl) {
                        currentValueEl.textContent = selectedValue;
                      }
                    }
                  }
                  
                  // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ— è®ºæ˜¯å“ªä¸ªé€‰é¡¹å˜åŒ–ï¼Œéƒ½è¦æ›´æ–°æ‰€æœ‰é€‰é¡¹çš„å¯ç”¨æ€§
                  console.log('  â†’ Updating all options availability');
                  
                  // å»¶è¿Ÿä¸€ä¸‹ï¼Œç­‰å¾…ä¸»é¢˜ JS æ›´æ–°å®Œä¸» form çš„å…¶ä»–é€‰é¡¹
                  setTimeout(function() {
                    console.log('  â†’ Delayed update: syncing all options from main form');
                    updateAvailableOptions();
                  }, 50);
                }
              }
            });
          });
          
          // ç›‘å¬ä¸» swatch ä¸­æ‰€æœ‰ items çš„ class å˜åŒ–
          mainSwatch.querySelectorAll('[data-swatch-item]').forEach(function(item) {
            observer.observe(item, { attributes: true, attributeFilter: ['class'] });
          });
          
          console.log('âœ… Observer attached to main swatch');
          
          // ğŸ”§ é¢å¤–ç›‘å¬ï¼šç›‘å¬ä¸» swatch ä¸­æ‰€æœ‰ items çš„ style å’Œ class å˜åŒ–ï¼ˆæ•è· display: noneï¼‰
          var displayObserver = new MutationObserver(function(mutations) {
            var needsUpdate = false;
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && 
                  (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                needsUpdate = true;
              }
            });
            
            if (needsUpdate) {
              console.log('ğŸ”„ Main swatch display/class changed, updating independent swatch');
              setTimeout(function() {
                updateAvailableOptions();
              }, 50);
            }
          });
          
          // ç›‘å¬ä¸» swatch ä¸­æ‰€æœ‰ items çš„ style å’Œ class å˜åŒ–
          mainSwatch.querySelectorAll('[data-swatch-item]').forEach(function(item) {
            displayObserver.observe(item, { 
              attributes: true, 
              attributeFilter: ['style', 'class'] 
            });
          });
          
          console.log('âœ… Display observer attached to main swatch');
        }
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°å¯ç”¨é€‰é¡¹
        console.log('ğŸ”§ Initial update of available options');
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆå§‹åŒ–æ—¶ç›´æ¥ä»ä¸» form åŒæ­¥çŠ¶æ€ï¼Œè€Œä¸æ˜¯è‡ªå·±è®¡ç®—
        if (mainSwatch || mainWrapper) {
          console.log('ğŸ” Syncing initial state from main form');
          
          // éå†ç‹¬ç«‹é€‰æ‹©å™¨ä¸­çš„æ‰€æœ‰é€‰é¡¹
          independentSwatch.querySelectorAll('[data-swatch-option]').forEach(function(independentOption) {
            // ğŸ”§ ä½¿ç”¨æ”¹è¿›çš„æŸ¥æ‰¾å‡½æ•°
            var mainOption = findMainOption(independentOption);
            
            if (!mainOption) {
              console.log('âš ï¸ Main option not found, skipping');
              return;
            }
            
            var optionIndex = independentOption.getAttribute('data-id');
            console.log('âœ… Found main option for index:', optionIndex);
            
            // éå†ç‹¬ç«‹é€‰æ‹©å™¨ä¸­çš„æ¯ä¸ª item
            independentOption.querySelectorAll('[data-swatch-item]').forEach(function(independentItem) {
              var itemValue = independentItem.getAttribute('data-value');
              
              // æŸ¥æ‰¾ä¸» form ä¸­å¯¹åº”çš„ item
              var mainItem = mainOption.querySelector('[data-swatch-item][data-value="' + itemValue + '"]');
              
              if (!mainItem) {
                // ä¸» form ä¸­æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œéšè—å®ƒ
                console.log('âš ï¸ Item not in main form, hiding:', itemValue);
                independentItem.classList.add('is--soldout', 'is--unavailable', 'is--hidden');
                independentItem.style.display = 'none';
              } else {
                // ğŸ”§ å…³é”®ï¼šç›´æ¥å¤åˆ¶ä¸» form çš„çŠ¶æ€
                console.log('ğŸ“‹ Syncing item state:', itemValue, 'from main form');
                
                // å¤åˆ¶ soldout çŠ¶æ€
                if (mainItem.classList.contains('is--soldout')) {
                  console.log('  â†’ Item is soldout in main form');
                  independentItem.classList.add('is--soldout', 'is--unavailable', 'is--hidden');
                  independentItem.style.display = 'none';
                } else {
                  console.log('  â†’ Item is available in main form');
                  independentItem.classList.remove('is--soldout', 'is--unavailable', 'is--hidden');
                  independentItem.style.display = '';
                }
                
                // å¤åˆ¶é€‰ä¸­çŠ¶æ€
                if (mainItem.classList.contains('is--selected')) {
                  console.log('  â†’ Item is selected in main form');
                  independentItem.classList.add('is--selected');
                  
                  // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                  var currentValueEl = independentOption.querySelector('[data-current-value]');
                  if (currentValueEl) {
                    currentValueEl.textContent = itemValue;
                  }
                } else {
                  independentItem.classList.remove('is--selected');
                }
                
                // å¤åˆ¶ display çŠ¶æ€
                if (mainItem.style.display === 'none') {
                  console.log('  â†’ Item is hidden in main form');
                  independentItem.style.display = 'none';
                  independentItem.classList.add('is--hidden');
                }
              }
            });
          });
          
          console.log('âœ… Initial state synced from main form');
        } else {
          // å¦‚æœæ²¡æœ‰ä¸» swatchï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
          updateAvailableOptions();
        }
      }
      
      // é¡µé¢åŠ è½½ååˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initIndependentColorSelector);
      } else {
        initIndependentColorSelector();
      }
    })();
  </script>
  
  {%- comment -%} CSS: ç¦ç”¨çŠ¶æ€æ ·å¼ - ä¸å¯ç”¨çš„é€‰é¡¹ç›´æ¥éšè— {%- endcomment -%}
  <style>
    [data-independent-color-selector] [data-swatch-item].is--soldout,
    [data-independent-color-selector] [data-swatch-item].is--unavailable,
    [data-independent-color-selector] [data-swatch-item].is--hidden {
      display: none !important;
    }
  </style>
{%- endif -%}
