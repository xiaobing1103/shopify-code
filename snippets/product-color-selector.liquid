{%- comment -%}
  Product Color Selector Snippet - ç‹¬ç«‹çš„ Color Selector Block
  
  è¿™ä¸ª snippet åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ color selectorï¼Œå®ƒä¼šï¼š
  1. æ¸²æŸ“ä¸€ä¸ªéšè—çš„ product formï¼ˆåŒ…å«å®Œæ•´çš„ variant é€»è¾‘ï¼‰
  2. åªæ˜¾ç¤º color é€‰é¡¹
  3. ä½¿ç”¨ä¸»é¢˜è‡ªå¸¦çš„ JavaScript æ¥å¤„ç† variant åˆ‡æ¢
  
  Parameters:
  - product: Product object
  - current_variant: Current variant object
  - pr_se_id: Product section ID
  - bk_stts: Block settings
  - isProductDefault: Boolean
  - get_color: Array of color keywords
  - choose_an_option: Translation string
  - name_sizeg: Size guide name
  - html_sizeg: Size guide HTML
  - show_tooltip: Tooltip setting
{%- endcomment -%}

{%- liquid
  assign color_mode = bk_stts.color_mode | default: 'color'
  assign selector_mode = bk_stts.selector_mode | default: 'default'
  assign color_size = bk_stts.color_size | default: 'medium'
  
  assign color_swatch = 'disabled-'
  assign color_mode_list = 'color, color is-sw-cl__round, variant_image, variant_image is-sw-cl__round' | split: ', '
  if color_mode_list contains color_mode
    assign color_swatch = 'is-sw__color '
  endif
  
  if color_mode contains 'color' or color_mode contains 'variant'
    assign show_tooltip = ''
  else
    assign show_tooltip = '-off'
  endif
-%}

{%- if isProductDefault == false -%}
  {{ 'swatch.css' | asset_url | append: '?v=20251201-v3' | stylesheet_tag }}
  
  {%- comment -%} åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ form ID {%- endcomment -%}
  {%- assign independent_form_id = 'product-form-independent-' | append: pr_se_id -%}
  
  {%- comment -%} æ¸²æŸ“ä¸€ä¸ªç‹¬ç«‹çš„ product formï¼ŒåŒ…å«å¿…è¦çš„åŒ…è£…å™¨ {%- endcomment -%}
  <div class="t4s-independent-color-selector-wrapper">
    <div data-callBackVariant id="t4s-callBackVariant{{ independent_form_id }}">
      {%- comment -%} éšè—çš„ JSON æ•°æ®ï¼ˆä¸»é¢˜ JS éœ€è¦ï¼‰{%- endcomment -%}
      <script class="pr_variants_json" type="application/json">
        {{ product.variants | json }}
      </script>
      <script class="pr_options_json" type="application/json">
        {{ product.options_with_values | json }}
      </script>
      
      <form 
        id="{{ independent_form_id }}"
        class="t4s-product-form"
        data-productid="{{ product.id }}"
        data-type="add-to-cart-form"
        style="display: contents;"
      >
      {%- comment -%} éšè—çš„ variant selectï¼ˆä¸»é¢˜ JS éœ€è¦å®ƒæ¥å·¥ä½œï¼‰{%- endcomment -%}
      <select name="id" style="display: none;">
        {%- for variant in product.variants -%}
          <option 
            value="{{ variant.id }}"
            {% if variant == current_variant %}selected="selected"{% endif %}
          >
            {{ variant.title }}
          </option>
        {%- endfor -%}
      </select>
      
      {%- comment -%} åªæ¸²æŸ“ color selector {%- endcomment -%}
      <div 
        class="t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ color_size }} t4s-selector-mode__{{ selector_mode }}"
        data-independent-color-selector
      >
    {%- for option in product.options_with_values -%}
      {%- liquid
        if option.values.size == 1
          assign selected_value = option.values.first
        else
          assign option_index = 'option' | append: forloop.index
          assign selected_value = current_variant[option_index]
        endif
        assign option_name = option.name
        assign name_downcase = option_name | downcase
      -%}

      {%- if get_color contains name_downcase -%}
        <div
          data-swatch-option
          data-id="{{ forloop.index0 }}"
          class="t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }}"
        >
          <h4 class="t4s-swatch__title">
            <span>
              {{- option_name }}:
              <span data-current-value class="t4s-dib t4s-swatch__current">
                {{- selected_value | default: choose_an_option -}}
              </span>
            </span>
            {%- if name_sizeg == name_downcase %}{{ html_sizeg }}{% endif %}
          </h4>
          <div data-swatch-list class="t4s-swatch__list">
            {%- if color_mode != 'dropdown' -%}
              {%- for value in option.values -%}
                {%- liquid
                  assign swatch_focal_point = null
                  if value.swatch.image
                    assign image_url = value.swatch.image | image_url: width: 100, height: 100
                    assign swatch_value = 'url(' | append: image_url | append: ')'
                    assign swatch_focal_point = value.swatch.image.presentation.focal_point
                  elsif value.swatch.color
                    assign swatch_value = value.swatch.color
                  else
                    assign swatch_value = null
                  endif
                -%}
                <div
                  data-swatch-item
                  data-tooltip{{ show_tooltip }}="top"
                  title="{{ value | escape }}"
                  class="t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                  data-value="{{ value | escape }}"
                  {% if swatch_value %}
                    style="--swatch--background: {{ swatch_value }};{% if swatch_focal_point %} --swatch-focal-point: {{ swatch_focal_point }};{% endif %}"
                  {% endif %}
                >
                  {{ value }}
                </div>
              {%- endfor -%}

            {%- else -%}
              <button
                type="button"
                data-dropdown-open
                data-position="bottom-end"
                data-id="t4s_nt_{{ pr_se_id }}{{ forloop.index }}"
              >
                <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                <svg class="t4s-icon-select-arrow" role="presentation" viewBox="0 0 19 12">
                  <use xlink:href="#t4s-select-arrow"></use>
                </svg>
              </button>
              <div
                data-dropdown-wrapper
                class="t4s-dropdown__wrapper t4s-current-scrollbar"
                id="t4s_nt_{{ pr_se_id }}{{ forloop.index }}"
              >
                <div class="t4s-drop-arrow"></div>
                <div class="t4s-dropdown__header">
                  <span class="t4s-dropdown__title">
                    {{- option_name }}:
                    <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                  </span>
                  <button type="button" data-dropdown-close aria-label="{{ 'general.aria.close' | t }}">
                    <svg role="presentation" class="t4s-iconsvg-close" viewBox="0 0 16 14">
                      <path d="M15 0L1 14m14 0L1 0" stroke="currentColor" fill="none" fill-rule="evenodd"></path>
                    </svg>
                  </button>
                </div>
                <div class="t4s-dropdown__content">
                  {%- for value in option.values -%}
                    {%- liquid
                      assign swatch_focal_point = null
                      if value.swatch.image
                        assign image_url = value.swatch.image | image_url: width: 100, height: 100
                        assign swatch_value = 'url(' | append: image_url | append: ')'
                        assign swatch_focal_point = value.swatch.image.presentation.focal_point
                      elsif value.swatch.color
                        assign swatch_value = value.swatch.color
                      else
                        assign swatch_value = null
                      endif
                    -%}
                    <div
                      data-swatch-item
                      data-dropdown-off
                      class="t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                      data-value="{{ value | escape }}"
                      {% if swatch_value %}
                        style="--swatch--background: {{ swatch_value }};{% if swatch_focal_point %} --swatch-focal-point: {{ swatch_focal_point }};{% endif %}"
                      {% endif %}
                    >
                      {{ value }}
                    </div>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}
    {%- endfor -%}
      </div>
      </form>
    </div>
  </div>
  
  {%- comment -%} JavaScript: ç›´æ¥ç›‘å¬ swatch ç‚¹å‡»ï¼Œè§¦å‘ä¸» form çš„å¯¹åº” swatch {%- endcomment -%}
  <script>
    (function() {
      function initIndependentColorSelector() {
        var independentWrapper = document.querySelector('[data-callBackVariant][id="t4s-callBackVariant{{ independent_form_id }}"]');
        var mainWrapper = document.querySelector('[data-callBackVariant][id="t4s-callBackVariant{{ 'product-form-' | append: pr_se_id }}"]');
        
        if (!independentWrapper || !mainWrapper) {
          console.log('Wrappers not found, retrying...');
          setTimeout(initIndependentColorSelector, 100);
          return;
        }
        
        var independentSwatch = independentWrapper.querySelector('.t4s-swatch');
        var mainSwatch = mainWrapper.querySelector('.t4s-swatch');
        
        if (!independentSwatch || !mainSwatch) {
          console.log('Swatches not found, retrying...');
          setTimeout(initIndependentColorSelector, 100);
          return;
        }
        
        console.log('âœ… Independent color selector initialized');
        console.log('Independent wrapper:', independentWrapper);
        console.log('Main wrapper:', mainWrapper);
        console.log('Independent swatch:', independentSwatch);
        console.log('Main swatch:', mainSwatch);
        console.log('Main swatch options:', mainSwatch.querySelectorAll('[data-swatch-option]'));
        console.log('Main swatch display:', window.getComputedStyle(mainSwatch).display);
        
        // ç›‘å¬ç‹¬ç«‹ swatch çš„ç‚¹å‡»äº‹ä»¶
        independentSwatch.addEventListener('click', function(e) {
          var clickedItem = e.target.closest('[data-swatch-item]');
          if (!clickedItem) return;
          
          console.log('ğŸ¨ Independent swatch clicked');
          
          // é˜»æ­¢é»˜è®¤è¡Œä¸º
          e.preventDefault();
          e.stopPropagation();
          
          var swatchOption = clickedItem.closest('[data-swatch-option]');
          if (!swatchOption) return;
          
          var optionIndex = swatchOption.getAttribute('data-id');
          var selectedValue = clickedItem.getAttribute('data-value');
          
          console.log('Option index:', optionIndex, 'Value:', selectedValue);
          
          // æŸ¥æ‰¾ä¸» form ä¸­å¯¹åº”çš„ swatch item
          var mainSwatchOption = mainSwatch.querySelector('[data-swatch-option][data-id="' + optionIndex + '"]');
          if (!mainSwatchOption) {
            console.log('âŒ Main swatch option not found');
            console.log('Available main swatch options:', mainSwatch.querySelectorAll('[data-swatch-option]'));
            
            // å¦‚æœä¸» form ä¸­æ²¡æœ‰ color selectorï¼Œç›´æ¥æ›´æ–° select
            console.log('ğŸ”§ Trying to update select directly...');
            var mainForm = mainWrapper.querySelector('form');
            if (mainForm) {
              var mainSelect = mainForm.querySelector('select[name="id"]');
              if (mainSelect) {
                console.log('Found main select:', mainSelect);
                
                // è·å–äº§å“çš„ variants æ•°æ®
                var variantsJson = mainWrapper.querySelector('.pr_variants_json');
                if (variantsJson) {
                  try {
                    var variants = JSON.parse(variantsJson.textContent);
                    console.log('Variants:', variants);
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„ variantï¼ˆåªæ ¹æ® color é€‰é¡¹ï¼‰
                    var matchedVariant = variants.find(function(variant) {
                      return variant.option1 === selectedValue || 
                             variant.option2 === selectedValue || 
                             variant.option3 === selectedValue;
                    });
                    
                    if (matchedVariant) {
                      console.log('âœ… Found matching variant:', matchedVariant);
                      mainSelect.value = matchedVariant.id;
                      
                      // è§¦å‘ change äº‹ä»¶
                      var changeEvent = new Event('change', { bubbles: true });
                      mainSelect.dispatchEvent(changeEvent);
                      
                      console.log('âœ… Select updated and change event triggered');
                      
                      // æ‰‹åŠ¨æ›´æ–°ç‹¬ç«‹ selector çš„é€‰ä¸­çŠ¶æ€ï¼ˆå› ä¸ºä¸» form æ²¡æœ‰ swatch å¯ä»¥ç›‘å¬ï¼‰
                      var independentOption = independentSwatch.querySelector('[data-swatch-option][data-id="' + optionIndex + '"]');
                      if (independentOption) {
                        // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                        independentOption.querySelectorAll('[data-swatch-item]').forEach(function(item) {
                          item.classList.remove('is--selected');
                        });
                        
                        // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰ç‚¹å‡»çš„ item
                        clickedItem.classList.add('is--selected');
                        
                        // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                        var currentValueEl = independentOption.querySelector('[data-current-value]');
                        if (currentValueEl) {
                          currentValueEl.textContent = selectedValue;
                        }
                        
                        console.log('âœ… Independent selector visual state updated');
                      }
                    } else {
                      console.log('âŒ No matching variant found');
                    }
                  } catch (error) {
                    console.error('Error parsing variants:', error);
                  }
                } else {
                  console.log('âŒ Variants JSON not found');
                }
              } else {
                console.log('âŒ Main select not found');
              }
            } else {
              console.log('âŒ Main form not found');
            }
            return;
          }
          
          var mainSwatchItem = mainSwatchOption.querySelector('[data-swatch-item][data-value="' + selectedValue + '"]');
          if (!mainSwatchItem) {
            console.log('âŒ Main swatch item not found');
            return;
          }
          
          console.log('âœ… Found main swatch item, triggering click');
          
          // è§¦å‘ä¸» form çš„ swatch item ç‚¹å‡»
          // ä½¿ç”¨åŸç”Ÿç‚¹å‡»äº‹ä»¶ï¼Œè®©ä¸»é¢˜çš„ JavaScript å¤„ç†
          mainSwatchItem.click();
          
          console.log('âœ… Main swatch clicked');
        });
        
        // ç›‘å¬ä¸» swatch çš„å˜åŒ–ï¼ŒåŒæ­¥åˆ°ç‹¬ç«‹ swatch
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              var target = mutation.target;
              if (target.hasAttribute('data-swatch-item') && target.classList.contains('is--selected')) {
                var swatchOption = target.closest('[data-swatch-option]');
                if (!swatchOption) return;
                
                var optionIndex = swatchOption.getAttribute('data-id');
                var selectedValue = target.getAttribute('data-value');
                
                console.log('ğŸ”„ Main swatch changed, syncing to independent');
                
                // åŒæ­¥åˆ°ç‹¬ç«‹ swatch
                var independentOption = independentSwatch.querySelector('[data-swatch-option][data-id="' + optionIndex + '"]');
                if (independentOption) {
                  // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                  independentOption.querySelectorAll('[data-swatch-item]').forEach(function(item) {
                    item.classList.remove('is--selected');
                  });
                  
                  // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å¯¹åº”çš„ item
                  var independentItem = independentOption.querySelector('[data-swatch-item][data-value="' + selectedValue + '"]');
                  if (independentItem) {
                    independentItem.classList.add('is--selected');
                    
                    // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                    var currentValueEl = independentOption.querySelector('[data-current-value]');
                    if (currentValueEl) {
                      currentValueEl.textContent = selectedValue;
                    }
                  }
                }
              }
            }
          });
        });
        
        // ç›‘å¬ä¸» swatch ä¸­æ‰€æœ‰ items çš„ class å˜åŒ–
        mainSwatch.querySelectorAll('[data-swatch-item]').forEach(function(item) {
          observer.observe(item, { attributes: true, attributeFilter: ['class'] });
        });
        
        console.log('âœ… Observer attached to main swatch');
      }
      
      // é¡µé¢åŠ è½½ååˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initIndependentColorSelector);
      } else {
        initIndependentColorSelector();
      }
    })();
  </script>
{%- endif -%}
