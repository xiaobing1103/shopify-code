{%- liquid 
  assign item_id  = item.id
  assign item_key = item.key
  assign item_url = item.url
  assign image    = item.image
  assign item_qty = item.quantity
  assign item_variant = item.variant
  assign item_pr = item.product
  assign min_qty = item_pr.metafields.theme.cus_qty | default: min_qty
  if item_variant.quantity_rule.min and min_qty < item_variant.quantity_rule.min
    assign min_qty          = item_variant.quantity_rule.min
  endif
  assign current_inventory_quantity = item_variant.inventory_quantity
  if item_variant.inventory_management != null and current_inventory_quantity > 0 and item_variant.inventory_policy != 'continue'
    assign max_qty = current_inventory_quantity
  else
    assign max_qty = 9999
  endif
  if item_variant.quantity_rule.max and max_qty > item_variant.quantity_rule.max
    assign max_qty = item_variant.quantity_rule.max
  endif
-%}

 <div data-cart-item data-pid="{{ item.product_id }}" class="t4s-mini_cart__item cart_item_{{ item_id }} t4s-pr t4s-oh{% if gift_pr_id == item.product_id %} is--gift{% endif %}">
    {%- comment -%}Title and Variant Badge - Top Row{%- endcomment -%}
    <div class="t4s-mini_cart__header">
      <a href="{{ item_url }}" class="t4s-mini_cart__title">{{ item_pr.title }}</a>
      {%- assign qv_key = item_pr.id -%}
      {%- unless item_pr.has_only_default_variant or item_variant.title contains 'mczr_price_' -%}
        {%- assign qv_key = item_id -%}
        <span class="t4s-cart_variant_badge">
          <span class="t4s-variant_dot"></span>
          <span class="t4s-variant_text">{{ item_variant.title }}</span>
        </span>
      {%- endunless -%}
    </div>

    {%- comment -%}Image and Details Row{%- endcomment -%}
    <div class="t4s-mini_cart__body t4s-d-flex">
      <a href="{{ item_url }}" class="t4s-mini_cart__img t4s-pr t4s-oh t4s_ratio t4s-bg-11" style="background: url({{ image | image_url: width: 1 }});--aspect-ratioapt:{{ image.aspect_ratio | default: 1 }}">
        {%- if image != blank -%}
          <img class="lazyloadt4s" width="120" height="{{ 120 | divided_by: image.aspect_ratio | ceil }}" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="{{ image | image_url: width: 1 }}" data-widths="[120, 240]" data-sizes="auto" alt="{{ image.alt | escape }}">
        {%- endif -%}
        <div class="t4s-cart-ld__bar t4s-pe-none t4s-dn" hidden><span>
          <svg width="16" height="16" hidden class="t4s-cart-spinner" focusable="false" role="presentation" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
            <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
          </svg>
          <svg class="t4s-cart-check" viewBox="0 0 448 512" width="16" height="16" hidden><use href="#icon-cart-check"/></svg>
        </span></div>
      </a>
      <div class="t4s-mini_cart__info">
         <div class="t4s-mini_cart__meta">
          {%- if item.selling_plan_allocation != blank %}<p class="t4s-cart_selling_plan">{{ item.selling_plan_allocation.selling_plan.name }}</p>{% endif -%}
          {%- assign property_size = item.properties | size -%}
          {%- if property_size > 0 -%}
          {%- comment -%} 收集上传文件和设计备注信息 - 使用固定属性名 {%- endcomment -%}
          {%- liquid
            assign has_upload_file = false
            assign upload_file_url = ''
            assign upload_file_name = ''
            assign design_note_text = ''
            for p in item.properties
              assign first_char = p.first | slice: 0
              comment
                跳过系统属性，但要读取文件名
              endcomment
              if p.first == '_tm_customer_upload_filename' and p.last != blank
                assign upload_file_name = p.last
                continue
              endif
              if first_char == '_' or p.last == blank
                continue
              endif
              comment
                提取上传文件 - 使用固定属性名 tm_customer_upload_image 或兼容旧的 /uploads/ 判断
              endcomment
              if p.first == 'tm_customer_upload_image' or p.last contains '/uploads/'
                assign has_upload_file = true
                assign upload_file_url = p.last
                comment
                  如果没有从隐藏字段获取到文件名，则从 URL 提取
                endcomment
                if upload_file_name == blank
                  assign upload_file_name = p.last | split: '/' | last
                endif
                continue
              endif
              comment
                提取设计备注 - 使用固定属性名 tm_customer_remark
              endcomment
              if p.first == 'tm_customer_remark'
                assign design_note_text = p.last
                continue
              endif
            endfor
          -%}
          <ul class="t4s-cart_meta_propertyList">
            {%- for p in item.properties -%}
                {%- liquid
                  assign p_first = p.first
                  assign p_last  = p.last
                  assign p_first_lower = p_first | downcase
                  assign p_last_lower = p_last | downcase
                  assign first_character_in_key = p_first | slice: 0
                  if p_first contains '_bundle_' or p_first contains '_mczr_' or first_character_in_key == '_' or p_last == blank
                      continue
                  endif
                  
                  comment
                    跳过固定属性名（将在统一上传区域显示）
                  endcomment
                  if p_first == 'tm_customer_upload_image' or p_first == 'tm_customer_remark'
                    continue
                  endif
                  
                  comment
                    跳过上传文件属性（兼容旧数据）
                  endcomment
                  if p_last contains '/uploads/'
                    continue
                  endif
                  
                  if p_first == 'shipping_interval_frequency'
                      assign frequency = p_last
                      assign recurringchecked = true
                      continue 
                  elsif p_first == 'shipping_interval_unit_type'
                      if frequency == '1'
                          if p_last == 'Days'
                              assign frequency_unit = 'Day'
                          elsif p_last == 'Months'
                              assign frequency_unit = 'Month'
                          elsif p_last == 'Weeks'
                              assign frequency_unit = 'Week'
                          endif
                      else
                          assign frequency_unit = p_last
                      endif
                      continue
                  endif
                -%}
                
                <li class="t4s-product-details__item product-details__item--property">
                  <span class="t4s-product-details__item-label"><strong>{{ p_first }}:</strong> </span>
                  <span>{{ p_last }}</span>
                </li>

            {%- endfor -%}
            
            {%- comment -%} 显示上传图片区域 - 图片左边 + 右侧信息盒子 {%- endcomment -%}
            {%- if has_upload_file -%}
            <li class="t4s-product-details__item t4s-cart-upload-display">
              <div class="t4s-cart-upload-container">
                <div class="t4s-cart-upload-image">
                  <a href="{{ upload_file_url }}" target="_blank" rel="noopener">
                    <img src="{{ upload_file_url }}" alt="{{ upload_file_name }}" width="60" height="40" loading="lazy" style="width: auto !important; height: 40px; max-width:60px; object-fit: contain;">
                  </a>
                </div>
                <div class="t4s-cart-upload-info">
                  <div class="t4s-cart-upload-filename" title="{{ upload_file_name }}">{{ upload_file_name }}</div>
                  {%- if design_note_text != blank -%}
                  <div class="t4s-cart-design-note" title="{{ design_note_text | escape }}">{{ design_note_text }}</div>
                  {%- endif -%}
                </div>
              </div>
            </li>
            {%- elsif design_note_text != blank -%}
            {%- comment -%} 只有备注没有上传图片时单独显示备注 {%- endcomment -%}
            <li class="t4s-product-details__item product-details__item--property">
              <span class="t4s-product-details__item-label"><strong>{{ 'cart.general.design_note' | t | default: 'Design Note' }}:</strong> </span>
              <span>{{ design_note_text }}</span>
            </li>
            {%- endif -%}
          </ul>
          {%- endif -%}
          {%- if recurringchecked %}<span class="t4s-product-details__item-recurring t4s-ch">{{ 'cart.general.recurring_mess' | t: frequency: frequency, frequency_unit: frequency_unit }}</span>{% endif -%}

          {%- comment -%}Calculate per-item discount from cart-level discounts{%- endcomment -%}
          {%- liquid
            assign item_discount_amount = 0
            if cart.cart_level_discount_applications.size > 0
              assign total_cart_discount = 0
              for discount_app in cart.cart_level_discount_applications
                assign total_cart_discount = total_cart_discount | plus: discount_app.total_allocated_amount
              endfor
              assign cart_items_count = cart.items.size
              if cart_items_count > 0
                assign item_discount_amount = total_cart_discount | divided_by: cart_items_count
              endif
            endif
          -%}

          <div class="t4s-cart_meta_price">
              <div class="t4s-cart_price_wrapper">
                <div class="t4s-cart_price">
                  {%- liquid
                   assign original_price     = item.original_price
                   assign final_price        = item.final_price
                   assign v_compare_at_price = item_variant.compare_at_price
                   assign item_compare_price = v_compare_at_price | default: original_price | times: item_qty
                   assign compare_tt_price   = compare_tt_price | plus: item_compare_price
                   if cur_code_enabled
                     assign money_original_price = original_price | money_with_currency
                     assign money_final_price    = final_price | money_with_currency
                   else
                     assign money_original_price = original_price | money
                     assign money_final_price    = final_price | money
                   endif -%}

                  {%- if original_price != final_price -%}
                     <del>{{ money_original_price }}</del><ins>{{ money_final_price }}</ins>
                  {%- elsif v_compare_at_price > original_price -%}
                     <del>{% if cur_code_enabled %}{{ v_compare_at_price | money_with_currency }}{% else %}{{ v_compare_at_price | money }}{% endif %}</del><ins>{{ money_final_price }}</ins>
                  {%- else -%}
                     {{ money_original_price }}
                  {%- endif -%}
                </div>

                {%- comment -%}Display per-item discount if cart-level discount exists{%- endcomment -%}
                {%- if item_discount_amount > 0 -%}
                  <div class="t4s-cart_item_discount">
                    <svg viewBox="0 0 24 24" width="14"><use href="#icon-cart-tag"/></svg>
                    {%- for discount_app in cart.cart_level_discount_applications -%}
                      {%- if forloop.first -%}
                        {{ discount_app.title }}
                      {%- endif -%}
                    {%- endfor -%}
                    (-{{ item_discount_amount | money }})
                  </div>
                {%- endif -%}
              </div>
              {%- if item.unit_price_measurement -%}
                 {%- capture unit_price_base_unit -%}
                   {%- if item.unit_price_measurement.reference_value != 1 -%}
                     {{- item.unit_price_measurement.reference_value -}}
                   {%- endif -%}
                   {{ item.unit_price_measurement.reference_unit }}
                 {%- endcapture -%}
                 <div class="t4s-cart_unit_price">{{ item.unit_price | money }}<span>/</span>{{- unit_price_base_unit -}}</div>
              {%- endif -%}
              {%- if item.line_level_discount_allocations != blank -%}
                 <ul class="t4s-cart_discount_price">
                    {%- for discount_allocation in item.line_level_discount_allocations -%}
                      <li class="t4s-order-discount__item"><svg viewBox="0 0 24 24" width="20"><use href="#icon-cart-tag"/></svg> {{ discount_allocation.discount_application.title }} (-{{ discount_allocation.amount | money }})</li>
                    {%- endfor -%}
                 </ul>
              {%- endif -%}
          </div>
       </div>
       <div class="t4s-mini_cart__actions">
          <div class="t4s-cart__actions-row">
            {%- if cart_ajax_enable -%}
            <div data-quantity-wrapper class="t4s-quantity-wrapper t4s-quantity-cart-item">
              <button data-quantity-selector data-decrease-qty type="button" class="t4s-quantity-selector is--minus">
                <svg focusable="false" class="icon icon--minus" viewBox="0 0 10 2" role="presentation"><path d="M10 0v2H0V0z" fill="currentColor"></path></svg>
              </button>
              <input data-action-change data-quantity-value type="number" id="miniupdates_{{ item_key }}" data-id="{{ item_key }}" class="t4s-quantity-input" step="{{ item_variant.quantity_rule.increment | default: 1 }}" min="{{ min_qty }}" max="{{ max_qty }}" name="updates[]" data-current-qty="{{ item_qty }}" value="{{ item_qty }}" size="4" pattern="[0-9]*" inputmode="numeric">
              <button data-quantity-selector data-increase-qty type="button" class="t4s-quantity-selector is--plus">
                <svg focusable="false" class="icon icon--plus" viewBox="0 0 10 10" role="presentation"><path d="M6 4h4v2H6v4H4V6H0V4h4V0h2v4z" fill="currentColor" fill-rule="evenodd"></path></svg>
              </button>
            </div>
            {%- endif -%}
            <div class="t4s-cart__btn-group">
              {%- if item_pr.has_only_default_variant == false and atc_ajax_enable -%}
              <a href="{{ item_url }}" rel="nofollow" class="t4s-mini_cart__edit" data-action-quickshop data-edit="{{ edit_item }}" data-id="{{ qv_key }}" data-key="{{ item_key }}" data-no-instant data-tooltip="top-start" data-t4s-tooltip='{{ 'cart.general.edit_item' | t | escape }}'>
                <svg viewBox="0 0 24 24" width="18" height="18"><use href="#icon-cart-edit"/></svg>
              </a>
              {%- endif -%}
              <a href="{{ cart_change_url }}?quantity=0&amp;id={{ item_key }}" rel="nofollow" class="t4s-mini_cart__remove" data-no-instant data-cart-remove data-id="{{ item_key }}" data-tooltip="top-start" data-t4s-tooltip='{{ 'cart.general.remove_item' | t | escape }}'>
                <svg viewBox="0 0 24 24" width="18"><use href="#icon-cart-remove"/></svg>
              </a>
            </div>
          </div>
       </div>
      </div>
    </div>
 </div>