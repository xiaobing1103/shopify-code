{%- comment -%}
  Product Media - Thumbnails Layout
  ç¼©ç•¥å›¾å¸ƒå±€ï¼ˆå·¦ä¾§ã€å³ä¾§ã€åº•éƒ¨ã€æ— ç¼©ç•¥å›¾ï¼‰
  
  å‚æ•°:
  - media_layout: å¸ƒå±€ç±»å‹
  - product_media: äº§å“åª’ä½“æ•°ç»„
  - se_stts: section settings
  - se_id: section id
  - image_ratio: å›¾ç‰‡æ¯”ä¾‹
  - imgatt: å›¾ç‰‡å±æ€§
  - variant_images: å˜ä½“å›¾ç‰‡
  - enable_video_looping: è§†é¢‘å¾ªç¯
  - enable_video_muting: è§†é¢‘é™éŸ³
  - enable_video_autoplaying: è§†é¢‘è‡ªåŠ¨æ’­æ”¾
  - height: é«˜åº¦
  - isMediaHidden: åª’ä½“éšè—çŠ¶æ€
  - current_option1/2/3: å½“å‰é€‰é¡¹
  - ops_name, ops_name_1/2/3: é€‰é¡¹åç§°
  - class_pswp_disable: pswp ç¦ç”¨ç±»
  - variants_size: å˜ä½“æ•°é‡
  - canMedia_group: æ˜¯å¦å¯ä»¥åˆ†ç»„
  - has_media_360: æ˜¯å¦æœ‰360åº¦è§†å›¾
  - media_custom_img_enable: æ˜¯å¦å¯ç”¨è‡ªå®šä¹‰å›¾ç‰‡
  - media_custom_img: è‡ªå®šä¹‰å›¾ç‰‡
  - media_heading: åª’ä½“æ ‡é¢˜
  - product: äº§å“å¯¹è±¡
{%- endcomment -%}

{%- liquid
  if media_layout == 'thumbnails_left'
    assign class_main = 't4s-col-lg t4s-order-lg-last '
    assign class_thumb = 't4s-col-lg-auto t4s-order-lg-first '
  elsif media_layout == 'thumbnails_right'
    assign class_main = 't4s-col-lg '
    assign class_thumb = 't4s-col-lg-auto '
  else
    assign class_gx_lg = ' t4s-g-lg-10 '
  endif
-%}

{{ 'slider-settings.css' | asset_url | stylesheet_tag }}

<div class="t4s-row t4s-g-0" timeline hdt-reveal="slide-in">
  <div data-product-single-media-group class="{{ class_main }}t4s-col-12 t4s-col-item t4s-pr">
    <div
      data-t4s-gallery
      data-main-media
      data-t4s-thumb-true
      class="t4s-row t4s-g-0 t4s-slide-eff-{{ se_stts.eff }} flickityt4s t4s_{{ image_ratio }} t4s_position_{{ se_stts.image_position }} t4s_{{ se_stts.image_size }} t4s-flicky-slider {% if se_stts.nav_btn %} t4s-slider-btn-{{ se_stts.nav_btn }} t4s-slider-btn-style-{{ se_stts.btn_owl }} t4s-slider-btn-{{ se_stts.btn_shape }} t4s-slider-btn-{{ se_stts.btn_size }} t4s-slider-btn-cl-{{ se_stts.btn_cl }} t4s-slider-btn-vi-{{ se_stts.btn_vi }} t4s-slider-btn-hidden-mobile-{{ se_stts.btn_hidden_mobile }} {% endif %} {% if se_stts.nav_dot %} t4s-dots-style-{{ se_stts.dot_owl }} t4s-dots-cl-{{ se_stts.dots_cl }} t4s-dots-round-{{ se_stts.dots_round }} t4s-dots-hidden-mobile-{{ se_stts.dots_hidden_mobile }} {% endif %}"
      data-flickityt4s-js='{"t4sid": "{{ se_id }}", "status": true, "checkVisibility": false, "cellSelector": "[data-main-slide]:not(.is--media-hide)","isFilter":{{ canMedia_group }},"imagesLoaded": 0,"adaptiveHeight": 1, "contain": 1, "groupCells": "100%", "dragThreshold" : {% if se_stts.eff == 'fade' %}6{% else %}5{% endif %}, "cellAlign": "left","wrapAround": true,"prevNextButtons": {{ se_stts.nav_btn }},"percentPosition": 1,"pageDots": {{ se_stts.nav_dot }}, "autoPlay" : 0, "pauseAutoPlayOnHover" : true , "thumbNav": {% if media_layout != 'without_thumbnails' %}true{% else %}false{% endif %}, "thumbVertical": {% if media_layout != 'thumbnails_bottom' %}true{% else %}false{% endif %}, "isMedia": true }'
      style="--flickity-btn-pos: 0px;--flickity-btn-pos-mb: 0px;--space-dots: {{ se_stts.dots_space }}px;"
    >
      {%- liquid
        for media in product_media
          if media.preview_image and media.preview_image.alt contains 'break--360'
            break
          endif
          render 'product-thumbnail', media: media, imgatt: imgatt, variant_images: variant_images, loop: enable_video_looping, mute: enable_video_muting, autoplay: enable_video_autoplaying, height: height, se_id: se_id, isMediaHidden: isMediaHidden, current_option1: current_option1, current_option2: current_option2, current_option3: current_option3, ops_name: ops_name, ops_name_1: ops_name_1, ops_name_2: ops_name_2, ops_name_3: ops_name_3, class_pswp_disable: class_pswp_disable, variants_size: variants_size
        endfor
        if has_media_360
          render 'product-360', product: product, se_id: se_id
        endif
      -%}
      {%- if se_stts.nav_dot and se_stts.dot_owl == 'number' -%}
        <div class="flickityt4s-page-dots t4s-dots-list carousel--status{{ se_id }}">
          <span data-current-slide></span> / <span data-total-number></span>
        </div>
      {%- endif -%}
    </div>
    <div
      data-product-single-badge
      data-sort="sale,new,soldout,preOrder,custom"
      class="t4s-single-product-badge lazyloadt4s t4s-pa t4s-pe-none t4s-op-0"
      data-rendert4s="css:{{ 'single-pr-badge.css' | asset_url }}"
    ></div>
    {%- if media_custom_img_enable and media_custom_img != blank -%}
      <div class="t4s-product-media-custom-img-{{ se_id }}">
        {{ media_custom_img | image_url: width: 400 | image_tag: loading: 'lazy', class: 't4s-obj-eff' }}
      </div>
    {%- endif -%}
    {%- if media_heading != blank -%}
      <div class="t4s-product-media-heading-{{ se_id }}">{{ media_heading }}</div>
    {%- endif -%}
    {%- render 'product-btns', se_stts: se_stts, product: product -%}
  </div>

  {%- if media_layout != 'without_thumbnails' -%}
    <div class="{{ class_thumb }}t4s-col-12 t4s-col-item t4s-col-thumb t4s-pr t4s-oh t4s-product-thumbnails-custom-wrapper">
      <div
        data-thumb__scroller="{{ se_id }}"
        class="t4s-carousel__nav-scroller is__position-{{ media_layout | remove: 'thumbnails_' }}"
      >
        <div class="t4s-row t4s-row-mt t4s-row-cols-4 t4s_{{ image_ratio }} t4s_position_{{ se_stts.image_position }} t4s_{{ se_stts.image_size }} {{ class_gx_lg }}t4s-g-5 t4s-carousel__nav carousel__nav--{{ se_id }} carousel__nav-hover1 t4s-product-thumbnails-custom" data-thumbnail-container>
          {%- assign thumb_count = 0 -%}
          {%- for media in product_media -%}
            {%- if media.preview_image and media.preview_image.alt contains 'break--360' -%}
              {%- continue -%}
            {%- endif -%}
            {%- assign image = media.preview_image -%}
            <div class="t4s-col-item t4s-product__thumb-item t4s-product__thumb-item-custom" data-thumb-index="{{ thumb_count }}">
              <div
                class="t4s_ratio t4s-product__thumb"
                {{ imgatt }}style="--aspect-ratioapt:{{ image.aspect_ratio }}"
              >
                <img
                  src="{{ image | image_url: width: 200 }}"
                  srcset="{{ image | image_url: width: 200 }} 200w, {{ image | image_url: width: 400 }} 400w"
                  sizes="(max-width: 767px) 20vw, 100px"
                  alt="{{ image.alt | escape }}"
                  width="200"
                  height="200"
                  loading="lazy"
                  class="t4s-product__thumb-img"
                >
              </div>
            </div>
            {%- assign thumb_count = thumb_count | plus: 1 -%}
          {%- endfor -%}
        </div>
      </div>
      
      {%- comment -%} ç¼©ç•¥å›¾å·¦å³å°ç®­å¤´ï¼ˆä»…ç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ {%- endcomment -%}
      <div class="t4s-thumb-nav-arrow t4s-thumb-nav-arrow-prev" data-thumb-prev-arrow aria-label="Previous image" style="display: flex;">
        &#8249;
      </div>
      <div class="t4s-thumb-nav-arrow t4s-thumb-nav-arrow-next" data-thumb-next-arrow aria-label="Next image" style="display: flex;">
        &#8250;
      </div>

      <button
        type="button"
        data-thumb-btn__prev="{{ se_id }}"
        aria-label="Previous"
        class="btn_pnav_prev t4s-pa t4s-pe-none t4s-op-0"
      ></button>
      <button
        type="button"
        data-thumb-btn__next="{{ se_id }}"
        aria-label="Next"
        class="btn_pnav_next t4s-pa t4s-pe-none t4s-op-0"
      ></button>
    </div>

    {%- comment -%} ç¼©ç•¥å›¾ç®­å¤´ç‚¹å‡»è„šæœ¬ - è§¦å‘ä¸»é¢˜åŸæœ‰æŒ‰é’® {%- endcomment -%}
    <script>
    (function() {
      console.log('ğŸ¯ Arrow Script Start');
      
      function init() {
        const customPrev = document.querySelector('[data-thumb-prev-arrow]');
        const customNext = document.querySelector('[data-thumb-next-arrow]');
        const themePrev = document.querySelector('[data-thumb-btn__prev="{{ se_id }}"]');
        const themeNext = document.querySelector('[data-thumb-btn__next="{{ se_id }}"]');
        
        console.log('Custom prev:', customPrev);
        console.log('Custom next:', customNext);
        console.log('Theme prev:', themePrev);
        console.log('Theme next:', themeNext);
        
        if (!customPrev || !customNext) {
          console.log('âŒ Custom arrows not found');
          return;
        }
        
        if (!themePrev || !themeNext) {
          console.log('âŒ Theme buttons not found');
          return;
        }
        
        // ç‚¹å‡»è‡ªå®šä¹‰ç®­å¤´æ—¶ï¼Œè§¦å‘ä¸»é¢˜åŸæœ‰æŒ‰é’®
        customPrev.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('â¬…ï¸ Custom PREV clicked, triggering theme button');
          themePrev.click();
          return false;
        };
        
        customNext.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('â¡ï¸ Custom NEXT clicked, triggering theme button');
          themeNext.click();
          return false;
        };
        
        console.log('âœ… Arrow click handlers attached!');
      }
      
      // å¤šæ¬¡å°è¯•åˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
      setTimeout(init, 500);
      setTimeout(init, 1000);
    })();
    </script>

    {%- comment -%} ç¼©ç•¥å›¾åŒæ­¥è„šæœ¬ {%- endcomment -%}
    <script>
      (function() {
        console.log('=== Thumbnail Sync Script Started ===');
        
        function initThumbnailSync() {
          const mainSlider = document.querySelector('[data-main-media]');
          const thumbnailItems = document.querySelectorAll('.t4s-product__thumb-item-custom');
          const thumbPrevArrow = document.querySelector('[data-thumb-prev-arrow]');
          const thumbNextArrow = document.querySelector('[data-thumb-next-arrow]');
          
          console.log('Main slider:', mainSlider);
          console.log('Thumbnail items:', thumbnailItems.length);
          console.log('Prev arrow:', thumbPrevArrow);
          console.log('Next arrow:', thumbNextArrow);
          
          if (!mainSlider || !thumbnailItems.length) {
            console.error('Required elements not found!');
            return;
          }

          const totalImages = thumbnailItems.length;
          let flickityInstance = null;
          let checkCount = 0;
          const maxChecks = 100;
          let isSetup = false;

          // æŒç»­æ£€æŸ¥Flickityå®ä¾‹
          const checkFlickity = setInterval(() => {
            checkCount++;
            
            // å°è¯•å¤šç§æ–¹å¼è·å–Flickityå®ä¾‹
            if (mainSlider.flickityData) {
              flickityInstance = mainSlider.flickityData;
            } else if (window.Flickity && mainSlider.classList.contains('flickityt4s-enabled')) {
              flickityInstance = window.Flickity.data(mainSlider);
            } else if (typeof jQuery !== 'undefined' && jQuery(mainSlider).data('flickityt4s')) {
              flickityInstance = jQuery(mainSlider).data('flickityt4s');
            }
            
            if (flickityInstance && !isSetup) {
              clearInterval(checkFlickity);
              console.log('âœ… Flickity instance found!', flickityInstance);
              isSetup = true;
              setupSync();
            } else if (checkCount >= maxChecks) {
              clearInterval(checkFlickity);
              console.error('âŒ Flickity not found after', maxChecks, 'attempts');
            } else if (checkCount % 10 === 0) {
              console.log('Still waiting for Flickity... attempt', checkCount);
            }
          }, 100);

          function setupSync() {
            console.log('Setting up thumbnail sync...');
            
            // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€å’Œç®­å¤´
            function updateUI(index) {
              console.log('ğŸ“ Updating UI for index:', index);
              
              // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
              thumbnailItems.forEach((item, i) => {
                if (i === index) {
                  item.classList.add('is-nav-selected');
                  console.log('  âœ“ Selected thumbnail', i);
                } else {
                  item.classList.remove('is-nav-selected');
                }
              });

              // æ›´æ–°ç®­å¤´æ˜¾ç¤ºï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
              if (window.innerWidth <= 767) {
                updateArrows(index);
              }
            }

            // æ›´æ–°ç®­å¤´æ˜¾ç¤º
            function updateArrows(index) {
              if (!thumbPrevArrow || !thumbNextArrow) {
                console.log('  âš ï¸ Arrows not found');
                return;
              }

              console.log('  ğŸ“Š Arrow update - Index:', index, 'Total:', totalImages);

              // å·¦ç®­å¤´
              if (index > 0) {
                thumbPrevArrow.classList.remove('t4s-dn');
                thumbPrevArrow.style.display = 'flex';
                console.log('  â† Prev arrow shown');
              } else {
                thumbPrevArrow.classList.add('t4s-dn');
                thumbPrevArrow.style.display = 'none';
                console.log('  â† Prev arrow hidden');
              }

              // å³ç®­å¤´
              if (index < totalImages - 1) {
                thumbNextArrow.classList.remove('t4s-dn');
                thumbNextArrow.style.display = 'flex';
                console.log('  â†’ Next arrow shown');
              } else {
                thumbNextArrow.classList.add('t4s-dn');
                thumbNextArrow.style.display = 'none';
                console.log('  â†’ Next arrow hidden');
              }
            }

            // ç›‘å¬Flickityçš„changeäº‹ä»¶
            try {
              flickityInstance.on('change', function(index) {
                console.log('ğŸ”„ Flickity change event fired - index:', index);
                updateUI(index);
              });
              console.log('âœ… Change event listener attached');
            } catch(e) {
              console.error('âŒ Failed to attach change listener:', e);
            }

            // ç›‘å¬Flickityçš„selectäº‹ä»¶ï¼ˆå¤‡ç”¨ï¼‰
            try {
              flickityInstance.on('select', function(index) {
                console.log('ğŸ¯ Flickity select event fired - index:', index);
                updateUI(index);
              });
              console.log('âœ… Select event listener attached');
            } catch(e) {
              console.error('âŒ Failed to attach select listener:', e);
            }

            // ç›‘å¬Flickityçš„settleäº‹ä»¶ï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰
            try {
              flickityInstance.on('settle', function(index) {
                console.log('âœ”ï¸ Flickity settle event fired - index:', index);
                const currentIndex = flickityInstance.selectedIndex;
                updateUI(currentIndex);
              });
              console.log('âœ… Settle event listener attached');
            } catch(e) {
              console.error('âŒ Failed to attach settle listener:', e);
            }

            // ç‚¹å‡»ç¼©ç•¥å›¾
            thumbnailItems.forEach((item, index) => {
              item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ‘† Thumbnail clicked:', index);
                
                if (flickityInstance) {
                  flickityInstance.select(index);
                  // ç«‹å³æ›´æ–°UI
                  setTimeout(() => updateUI(index), 50);
                }
              });
            });

            // å·¦ç®­å¤´ç‚¹å‡»
            if (thumbPrevArrow) {
              thumbPrevArrow.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('â¬…ï¸ Prev arrow clicked');
                
                if (flickityInstance) {
                  flickityInstance.previous();
                  // ç«‹å³æ›´æ–°UI
                  setTimeout(() => {
                    const idx = flickityInstance.selectedIndex;
                    console.log('After previous, index:', idx);
                    updateUI(idx);
                  }, 50);
                }
              });
              console.log('âœ… Prev arrow listener attached');
            }

            // å³ç®­å¤´ç‚¹å‡»
            if (thumbNextArrow) {
              thumbNextArrow.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('â¡ï¸ Next arrow clicked');
                
                if (flickityInstance) {
                  flickityInstance.next();
                  // ç«‹å³æ›´æ–°UI
                  setTimeout(() => {
                    const idx = flickityInstance.selectedIndex;
                    console.log('After next, index:', idx);
                    updateUI(idx);
                  }, 50);
                }
              });
              console.log('âœ… Next arrow listener attached');
            }

            // åˆå§‹åŒ–UI
            const currentIndex = flickityInstance.selectedIndex || 0;
            console.log('Initial index:', currentIndex);
            updateUI(currentIndex);

            // çª—å£å¤§å°æ”¹å˜
            window.addEventListener('resize', function() {
              if (flickityInstance) {
                const idx = flickityInstance.selectedIndex || 0;
                updateUI(idx);
              }
            });

            console.log('âœ… Thumbnail sync setup complete!');
          }
        }

        // å¤šæ¬¡å°è¯•åˆå§‹åŒ–
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            setTimeout(initThumbnailSync, 500);
          });
        } else {
          console.log('DOM already loaded, initializing...');
          setTimeout(initThumbnailSync, 500);
        }

        // å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
        setTimeout(function() {
          console.log('Delayed initialization (1s)...');
          initThumbnailSync();
        }, 1000);

        setTimeout(function() {
          console.log('Delayed initialization (2s)...');
          initThumbnailSync();
        }, 2000);

        window.addEventListener('load', function() {
          console.log('Window loaded, initializing...');
          setTimeout(initThumbnailSync, 1000);
        });
      })();
    </script>
  {%- endif -%}
</div>
